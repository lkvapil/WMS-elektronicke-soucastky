@startuml 02b_relational_model
hide circle
!theme cerulean-outline
title WMS Elektronické součástky\n② Konsolidovaný model pro relační databázi (PostgreSQL)

skinparam backgroundColor #FAFAFA
skinparam classBackgroundColor #FAD7A0
skinparam classBorderColor #E67E22
skinparam classArrowColor #784212
skinparam classFontSize 10
skinparam noteBackgroundColor #FFFDE7
skinparam noteBorderColor #F9A825

'══════════════════════════════════════════════════════════════════════════════
'  KATEGORIE
'══════════════════════════════════════════════════════════════════════════════

class kategorie_komponent {
  +id : SERIAL <<PK>>
  --
  name : VARCHAR(100) UNIQUE NOT NULL
  description : TEXT
  icon : VARCHAR(50)
  created_at : TIMESTAMPTZ
}

'══════════════════════════════════════════════════════════════════════════════
'  DĚDIČNOST KOMPONENT – Class Table Inheritance
'  každá tabulka má PK = cizí klíč na nadřazenou tabulku
'══════════════════════════════════════════════════════════════════════════════

class komponenty {
  +id : SERIAL <<PK>>
  --
  +category_id : INTEGER <<FK>>
  part_number : VARCHAR(100) UNIQUE NOT NULL
  name : VARCHAR(200) NOT NULL
  manufacturer : VARCHAR(150)
  barcode : VARCHAR(100)
  min_stock : INTEGER DEFAULT 0
  description : TEXT
  notes : TEXT
  is_active : BOOLEAN DEFAULT TRUE
  created_at : TIMESTAMPTZ
  updated_at : TIMESTAMPTZ
}

class pasivni_komponenty {
  +id : INTEGER <<PK/FK→komponenty>>
  --
  value : VARCHAR(50)
  unit : VARCHAR(20)
  tolerance : VARCHAR(20)
  voltage_rating : VARCHAR(30)
}

class aktivni_komponenty {
  +id : INTEGER <<PK/FK→komponenty>>
  --
  max_voltage : VARCHAR(30)
  max_current : VARCHAR(30)
  technology : VARCHAR(50)
}

class konektory {
  +id : INTEGER <<PK/FK→komponenty>>
  --
  pin_count : INTEGER
  pitch : VARCHAR(20)
  mounting : VARCHAR(30)
  gender : VARCHAR(20)
}

class rezistory {
  +id : INTEGER <<PK/FK→pasivni_komponenty>>
  --
  power_rating : VARCHAR(20)
  temp_coefficient : VARCHAR(20)
}

class kondenzatory {
  +id : INTEGER <<PK/FK→pasivni_komponenty>>
  --
  capacitance : VARCHAR(50)
  dielectric_type : VARCHAR(30)
  esr : VARCHAR(20)
}

class induktory {
  +id : INTEGER <<PK/FK→pasivni_komponenty>>
  --
  inductance : VARCHAR(50)
  saturation_current : VARCHAR(30)
}

class tranzistory {
  +id : INTEGER <<PK/FK→aktivni_komponenty>>
  --
  transistor_type : VARCHAR(30)
  hfe : VARCHAR(20)
  max_power : VARCHAR(20)
}

class integrovane_obvody {
  +id : INTEGER <<PK/FK→aktivni_komponenty>>
  --
  ic_family : VARCHAR(50)
  pin_count : INTEGER
  operating_voltage : VARCHAR(30)
}

class diody {
  +id : INTEGER <<PK/FK→aktivni_komponenty>>
  --
  diode_type : VARCHAR(30)
  forward_voltage : VARCHAR(20)
  reverse_voltage : VARCHAR(20)
}

'── Vazby dědičnosti (Class Table Inheritance) ──────────────────────────────
kategorie_komponent "1" --> "0..*" komponenty          : > kategorizuje
komponenty          "1" --> "0..1" pasivni_komponenty   : > rozšiřuje
komponenty          "1" --> "0..1" aktivni_komponenty   : > rozšiřuje
komponenty          "1" --> "0..1" konektory            : > rozšiřuje
pasivni_komponenty  "1" --> "0..1" rezistory            : > rozšiřuje
pasivni_komponenty  "1" --> "0..1" kondenzatory         : > rozšiřuje
pasivni_komponenty  "1" --> "0..1" induktory            : > rozšiřuje
aktivni_komponenty  "1" --> "0..1" tranzistory          : > rozšiřuje
aktivni_komponenty  "1" --> "0..1" integrovane_obvody   : > rozšiřuje
aktivni_komponenty  "1" --> "0..1" diody                : > rozšiřuje

'══════════════════════════════════════════════════════════════════════════════
'  SKLADOVÁ MÍSTA
'══════════════════════════════════════════════════════════════════════════════

class skladova_mista {
  +id : SERIAL <<PK>>
  --
  code : VARCHAR(50) UNIQUE NOT NULL
  name : VARCHAR(150)
  section : VARCHAR(50)
  shelf : VARCHAR(50)
  bin : VARCHAR(50)
  capacity : INTEGER
  is_active : BOOLEAN DEFAULT TRUE
}

'══════════════════════════════════════════════════════════════════════════════
'  ZÁSOBY – z vazební třídy Zasoba vznikla samostatná tabulka
'══════════════════════════════════════════════════════════════════════════════

class zasoby {
  +id : SERIAL <<PK>>
  --
  +component_id : INTEGER <<FK>>
  +location_id : INTEGER <<FK>>
  quantity : INTEGER NOT NULL
  reserved_qty : INTEGER DEFAULT 0
  unit_price : NUMERIC(12,4)
  updated_at : TIMESTAMPTZ
  ==
  trg_check_min_stock()
  trg_update_timestamp()
}

note right of zasoby
  UNIQUE(component_id, location_id)
  Trigger trg_check_min_stock
  kontroluje zásoby po každém UPDATE
  a generuje upozornění
end note

komponenty     "1" --> "*" zasoby : > eviduje zásoby
skladova_mista "1" --> "*" zasoby : > ukládá zásoby

'══════════════════════════════════════════════════════════════════════════════
'  KATALOG DODAVATELE
'  Implementace kvalifikované vazby Dodavatel[katalogCislo]→Komponenta
'══════════════════════════════════════════════════════════════════════════════

class dodavatele {
  +id : SERIAL <<PK>>
  --
  name : VARCHAR(200) NOT NULL
  code : VARCHAR(50) UNIQUE
  contact_person : VARCHAR(150)
  email : VARCHAR(255)
  phone : VARCHAR(50)
  website : VARCHAR(255)
  lead_time_days : INTEGER
  is_active : BOOLEAN DEFAULT TRUE
  created_at : TIMESTAMPTZ
}

class katalog_dodavatele {
  +id : SERIAL <<PK>>
  --
  +supplier_id : INTEGER <<FK>>
  +component_id : INTEGER <<FK>>
  katalog_cislo : VARCHAR(100) NOT NULL
  unit_price : NUMERIC(12,4)
  min_order_qty : INTEGER
}

note right of katalog_dodavatele
  UNIQUE(supplier_id, katalog_cislo)
  Implementuje kvalifikovanou vazbu:
  Dodavatel[katalogCislo] → 0..1 Komponenta
end note

dodavatele "1" --> "*" katalog_dodavatele : > nabízí
komponenty "1" --> "*" katalog_dodavatele : > v katalogu

'══════════════════════════════════════════════════════════════════════════════
'  UŽIVATELÉ
'══════════════════════════════════════════════════════════════════════════════

class uzivatele {
  +id : SERIAL <<PK>>
  --
  username : VARCHAR(80) UNIQUE NOT NULL
  email : VARCHAR(255) UNIQUE NOT NULL
  password_hash : VARCHAR(255) NOT NULL
  role : VARCHAR(20) NOT NULL
  full_name : VARCHAR(150)
  is_active : BOOLEAN DEFAULT TRUE
  created_at : TIMESTAMPTZ
  last_login : TIMESTAMPTZ
}

'══════════════════════════════════════════════════════════════════════════════
'  PROJEKTY
'══════════════════════════════════════════════════════════════════════════════

class projekty {
  +id : SERIAL <<PK>>
  --
  +created_by : INTEGER <<FK>>
  code : VARCHAR(50) UNIQUE NOT NULL
  name : VARCHAR(200) NOT NULL
  description : TEXT
  status : VARCHAR(30)
  created_at : TIMESTAMPTZ
}

projekty "*" --> "1" uzivatele : > vlastní

'══════════════════════════════════════════════════════════════════════════════
'  OBJEDNÁVKY
'══════════════════════════════════════════════════════════════════════════════

class objednavky {
  +id : SERIAL <<PK>>
  --
  +supplier_id : INTEGER <<FK>>
  +created_by : INTEGER <<FK>>
  order_number : VARCHAR(50) UNIQUE
  status : VARCHAR(30) NOT NULL
  order_date : DATE
  expected_delivery : DATE
  actual_delivery : DATE
  total_amount : NUMERIC(14,2)
  notes : TEXT
  created_at : TIMESTAMPTZ
  ==
  trg_recalculate_total()
}

'── z vazební třídy PolozkaObjednavky → mezilehlá tabulka ───────────────────
class polozky_objednavky {
  +id : SERIAL <<PK>>
  --
  +order_id : INTEGER <<FK>>
  +component_id : INTEGER <<FK>>
  quantity_ordered : INTEGER NOT NULL
  quantity_received : INTEGER DEFAULT 0
  unit_price : NUMERIC(12,4)
  notes : TEXT
}

dodavatele          "1"    --> "*" objednavky          : > dodává
objednavky          "*"    --> "1" uzivatele            : > vytvořil
objednavky          "1"    --> "*" polozky_objednavky   : > obsahuje
komponenty          "1"    --> "*" polozky_objednavky   : > objednávána

'══════════════════════════════════════════════════════════════════════════════
'  POHYBY ZÁSOB
'══════════════════════════════════════════════════════════════════════════════

class pohyby_zasob {
  +id : SERIAL <<PK>>
  --
  +component_id : INTEGER <<FK>>
  +from_location_id : INTEGER <<FK>>
  +to_location_id : INTEGER <<FK>>
  +project_id : INTEGER <<FK>>
  +order_item_id : INTEGER <<FK>>
  +created_by : INTEGER <<FK>>
  movement_type : VARCHAR(20) NOT NULL
  quantity : INTEGER NOT NULL
  unit_price : NUMERIC(12,4)
  reference : VARCHAR(100)
  notes : TEXT
  created_at : TIMESTAMPTZ
}

komponenty          "1"    --> "*"    pohyby_zasob : > pohyb
skladova_mista      "0..1" --> "*"    pohyby_zasob : > from
skladova_mista      "0..1" --> "*"    pohyby_zasob : > to
projekty            "0..1" --> "*"    pohyby_zasob : > výdej pro
polozky_objednavky  "0..1" --> "*"    pohyby_zasob : > navazuje
uzivatele           "1"    --> "*"    pohyby_zasob : > provedl

'══════════════════════════════════════════════════════════════════════════════
'  INVENTURA
'══════════════════════════════════════════════════════════════════════════════

class inventurni_cykly {
  +id : SERIAL <<PK>>
  --
  +created_by : INTEGER <<FK>>
  start_date : TIMESTAMPTZ
  end_date : TIMESTAMPTZ
  status : VARCHAR(30)
  notes : TEXT
  ==
  trg_lock_stock_on_start()
  trg_unlock_stock_on_close()
}

class polozky_inventury {
  +id : SERIAL <<PK>>
  --
  +cycle_id : INTEGER <<FK>>
  +stock_id : INTEGER <<FK>>
  expected_qty : INTEGER
  counted_qty : INTEGER
  is_confirmed : BOOLEAN DEFAULT FALSE
}

uzivatele        "1" --> "*" inventurni_cykly  : > zahájil
inventurni_cykly "1" --> "*" polozky_inventury : > obsahuje
zasoby           "1" --> "*" polozky_inventury : > inventarizuje

'══════════════════════════════════════════════════════════════════════════════
'  AUDIT LOG
'══════════════════════════════════════════════════════════════════════════════

class audit_log {
  +id : SERIAL <<PK>>
  --
  +created_by : INTEGER <<FK>>
  entity_type : VARCHAR(50)
  entity_id : INTEGER
  action : VARCHAR(30)
  old_values : JSONB
  new_values : JSONB
  ip_address : INET
  created_at : TIMESTAMPTZ
}

uzivatele "1" --> "*" audit_log : > generuje

@enduml
